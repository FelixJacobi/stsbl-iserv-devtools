#!/bin/bash -e

export LC_ALL=C
helper=$(which stsbl-dev-python-helper)

for i in usr db lib iconf src priv share config sbin bin iservchk roles appdata
do
  if [ ! -e "$PWD/$i/" ]
  then
    continue
  fi
  
  mkdir -pv "$i.collect/$i"
  
  if [ "$i" = "share" ]
  then
    find $i/ -mindepth 1 -type d -exec mkdir -pv "$i.collect"/{} \;
    find $i/ -mindepth 1 -type f -exec bash -c "file={}; $helper \${file/share\///} $i 'share/' '' '' 'share'" \;
  elif [ "$i" = "usr" ]
  then
    find $i -mindepth 1 -type d | xargs -i mkdir -pv "$i.collect/{}"
    find $i -mindepth 1 -type f | xargs -i cp --preserve=timestamps "/{}" "$i.collect/{}"  
  elif [ "$i" = "config" ]
  then
    find $i/ -mindepth 1 -type d -exec mkdir -pv "$i.collect"/{} \;
    find $i/ -mindepth 1 -type f -exec $helper {} $i '' 'iservcfg/' \;
  elif [ "$i" = "iservchk" ]
  then
    find $i/ -mindepth 1 -type d -exec mkdir -pv "$i.collect"/{} \;
    find $i/ -mindepth 1 -type f -exec $helper {} $i '' 'iconf/etc/iserv/chk.d/' 'iservchk' \;
  elif [ "$i" = "lib" ] || [ "$i" = "sbin" ] || [ "$i" = "bin" ]
  then
    find $i/ -mindepth 1 -type d -exec mkdir -pv "$i.collect"/{} \;
    find $i/ -mindepth 1 -type f -exec bash -ex -c 'subject={}; echo $subject; cp -v --preserve=timestamps "/usr/'$(path=$(echo $i | tr "/" "\n"); if [ "${path[0]}" = "lib" ]; then echo "lib/iserv"; elif [ "${path[0]}" = "sbin" ]; then echo -n; elif [ "${path[0]}" = "bin" ]; then echo -n; else echo $i; fi)'/$(echo $subject | sed s/lib//g)" "'$i'.collect/'$i'/$(echo $(dirname {}) | sed s/lib//g | sed s/sbin//g | sed s/bin//g)"' \;
  elif [ "$i" = "appdata" ]
  then
    find $i/ -mindepth 1 -type d -exec mkdir -pv "$i.collect"/{} \;
    
  else
    find $i/ -mindepth 1 -type d -exec mkdir -pv "$i.collect/"{} \;
    find $i/ -mindepth 1 -type f -exec $helper {} $i \;
  fi

  rm -rfv $i/
  mv -v $i".collect"/$i/ $i/

  rm -rfv ./$i".collect"/
done
